# Note: make permanent changes only in makefile.in,
# changes in makefile will be overwritten by configure.


.PHONY: default force mostlyclean clean distclean

default: run


export VPATH := $(CURDIR):$(CURDIR)/renconst:$(LT)/../include

INCLUDE := $(patsubst %,-I%,$(subst :, ,$(VPATH)))

PREFIX =

FFLAGS += $(INCLUDE)

ifdef DEBUG
FFLAGS += -g $(DEF)DEBUG
endif

export FC
export FFLAGS
export CC
export CFLAGS


LIBS = squaredme.a renconst.a util.a

$(LIBS): force
	$(MAKE) -C $*


DEPS := $(wildcard *.d)


mostlyclean:
	$(RM) $(DEPS) $(DEPS:%.d=%.o) $(DEPS:%.d=%)

clean: mostlyclean
	for dir in $(basename $(LIBS)) ; do \
	  $(MAKE) -C $$dir clean ; \
	done

distclean: mostlyclean
	for dir in $(basename $(LIBS)) ; do \
	  $(MAKE) -C $$dir distclean ; \
	done


MAKECMDGOALS ?= run

-include $(MAKECMDGOALS:%=%.d)

%.d: %.F
	( grep Mma $< >/dev/null 2>&1 ; \
	  echo "MMA = $$?" ; \
	  echo "$*: $@ $(LIBS)" ; \
	  $(CPP) -M $(INCLUDE) $< | sed 's/^.*:/$@:/' ) > $@

ifeq ($(MMA), 0)
%:: %.F %.d mktm
	./mktm $<
	$(FC) $(FFLAGS) $(DEF)MMA $(DEF)PREFIX=$(PREFIX) -c $<
	CC="$(CC)" mcc $(CFLAGS) -o $@ $*.tm $*.o $(LIBS) $(STDLIBS) $(LDFLAGS)
	-$(RM) $*.o $*.tm $*.tm.c
else
%:: %.F %.d
	$(FC) $(FFLAGS) $(DEF)PREFIX=$(PREFIX) -o $@ $< $(LIBS) $(STDLIBS)
	-$(RM) $*.o
endif

